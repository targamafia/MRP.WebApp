import{G as P,K as Q,M as E,T as I,H as p,L as O,h as T,E as f,N as j,O as U,J as _,P as B,Q as H,R,c as D,b as G,A as z}from"./appRouter.b765308b.js";import{r as h,b as l,j as e,a as w,N as A,F as N,O as q,Y as S,a1 as v,Q as $,$ as J,X as K,L as k,R as V,c as g,a2 as X}from"./index.d4a044e0.js";import{a as Y,M as W,c as M,u as Z,I as y,b as ee,N as F,A as se}from"./index.esm.838cd8ca.js";import{R as b,N as re}from"./404.b0102ae6.js";import{G as ae}from"./gradedAssessmentsList.ae1b86d3.js";import"./grade.16be42a5.js";const te=s=>{const[r,t]=h.exports.useState([]),a=()=>{if(!s.users)return t([]);const n=[];for(var i=0;i<s.users.length;i++){const u=s.users[i];for(var o=0;o<u.roles.length;o++){const m=u.roles[o];n.includes(m)||n.push(m)}}t(n)};return h.exports.useMemo(()=>{a()},[s.users]),l("div",{className:"rounded-md flex flex-col md:flex-row gap-8",children:[l("div",{className:"flex flex-row gap-4 items-center relative my-4 grow",children:[e("h3",{className:"mt-4 hidden","aria-hidden":!0,children:"Buscar"}),e("input",{type:"text",id:"query",placeholder:"Buscar",autoComplete:"off","aria-label":"Buscar",className:"outline outline-neutral-70 w-full mt-2 placeholder:text-neutral-50 pl-10",onChange:n=>s.dispatch({property:"query",value:n.currentTarget.value})}),e(Y,{className:"absolute left-2 mt-1 top-1/2 -translate-y-1/2"})]}),l("div",{className:"flex flex-col grow",children:[e("h3",{className:"mt-4",children:"Rol"}),e(W,{allOptions:r,selectedOptions:s.state.roles,onChange:n=>s.dispatch({property:"roles",value:n})})]})]})},ne=s=>{const r=w();return l("tr",{className:"bg-surface-4 text-main rounded-lg cursor-pointer hover:bg-surface-5 hover:border-surface-1 hover:shadow-sm overflow-hidden",onClick:()=>r(s.user._id||""),children:[e("td",{className:"px-4 py-2",children:l("h3",{children:[s.user.name," ",s.user.lastName]})}),e("td",{className:"px-4 py-2",children:e("p",{children:s.user.email})}),e("td",{className:"px-4 py-2",children:e("p",{children:s.user.companyCode})}),e("td",{className:"px-4 py-2 image.pngpointer-events-none",children:e(M,{elements:s.user.roles,noMargin:!0})}),e("td",{className:"",children:e(A,{to:s.user._id||"",children:e(P,{color:"info"})})})]})},le=s=>e("div",{className:"flex flex-col gap-4 w-full overflow-x-scroll",children:l("table",{className:"items-center border-spacing-y-2 border-separate w-full overflow-x-scoll",children:[e("thead",{children:l("tr",{className:"text-left",children:[e("th",{className:"px-4 py-2",children:"Nombre"}),e("th",{className:"px-4 py-2",children:"Correo"}),e("th",{className:"px-4 py-2",children:"Compa\xF1ia"}),e("th",{className:"px-4 py-2",children:"Roles"}),e("th",{})]})}),e("tbody",{children:s.users.length!==0?s.users.map((r,t)=>e(ne,{user:r},r._id)):e("tr",{children:e("td",{children:e("p",{children:"No se encontraron usuarios"})})})})]})}),ie=(s,r)=>{switch(r.property){case"roles":return s.roles.includes(r.value)?{...s,roles:s.roles.filter(t=>t!=r.value)}:{...s,roles:[r.value,...s.roles]};case"query":return{...s,query:r.value};default:return console.error("Unkown action property"),{...s}}},oe=()=>{const{users:s,loading:r,error:t}=Q(),[a,n]=h.exports.useReducer(ie,{roles:[],query:""}),i=h.exports.useMemo(()=>{if(!s)return[];const o=a.query!="",u=a.roles.length>0,m=new RegExp(a.query,"ig");return s.filter(d=>(!u||d.roles.some(c=>a.roles.includes(c)))&&(!o||[[d.name,d.lastName].join(" "),d.email,d.roles.join(" "),d.companyCode].some(c=>c!==void 0&&m.test(c))))},[s,a.roles,a.query]);return l(N,{children:[l(E,{children:[l("div",{className:"px-8 py-4 bg-surface-5 mb-12 rounded-lg shadow-inner",children:[e(I,{title:"Usuarios",cta:e(A,{to:"new",className:"bg-blue text-white px-4 py-2 rounded-md",children:"Crear nuevo usuario"})}),e("div",{className:"-mt-8"}),e(te,{users:s,state:a,dispatch:n})]}),e(p,{loading:r,error:t,children:()=>e(le,{users:i})})]}),e(q,{})]})},ce=()=>{const[s,r]=h.exports.useState(),[t,a]=h.exports.useState(!1),{register:n,handleSubmit:i}=Z({defaultValues:{name:"",lastName:"",role:"",email:""}}),o=x=>{r({type:"info",content:`"Se cre\xF3 la cuenta de ${x.email}" y se le envi\xF3 un c\xF3digo para generar su contrase\xF1a.`}),a(!0),setTimeout(()=>c(-1),2e3)},{mutate:u,error:m,isLoading:d}=O(o),c=w();return e(p,{error:m,loading:d,children:()=>l("form",{onSubmit:i(x=>u(x)),className:"flex flex-col gap-4",children:[e(y,{type:"text",name:"name",register:n,required:!0}),e(y,{type:"text",name:"lastName",register:n,required:!0,label:"Last Name"}),e(y,{type:"email",name:"email",register:n,required:!0}),l("div",{className:"flex flex-col gap-1",children:[e("label",{htmlFor:"role",children:"Tipo de usuario:"}),l("select",{...n("role",{required:!0}),children:[e("option",{value:"",children:"Rol"}),e("option",{value:"admin",children:"Administrador"}),e("option",{value:"consumer",children:"Usuario"})]})]}),!t&&e("input",{type:"submit",value:"Crear",className:"px-8 py-2 bg-blue rounded-md text-white cursor-pointer hover:bg-primary-40 mx-auto"}),!!s&&e(ee,{message:s.content,type:s.type})]})})},de=()=>l(E,{children:[l(b,{spacing:2,items:"center",wrap:!1,children:[e(A,{to:"../",className:"mb-8",children:e(T,{})}),e("h1",{className:"mb-8 grow",children:"Nuevo Usuario"})]}),e(ce,{})]}),ue=async s=>await S("/v1/users/password-recovery-pin",{email:s});function me(){const{id:s}=v();if(!s)return e(f,{message:"Missing assessment id"});const{stats:r,loading:t,error:a}=j(s);return e(p,{loading:t,error:a,children:()=>l("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-6 text-center",children:[e(U,{to:"history",data:r.takenAssessments,label:"Ex\xE1menes finalizados",loading:t,error:a}),e(U,{to:"assigned",data:r.premiumAssessments,label:"Ex\xE1menes asignados",loading:t,error:a})]})})}const he=()=>{const s=w(),{id:r}=v(),[t,a]=h.exports.useState(!1);if(!r)return e(f,{message:"Missing assessment id"});const{user:n,loading:i,error:o}=_(r),u=()=>{ue(n.email),a(!0)};return e(p,{loading:i,error:o,children:()=>l(N,{children:[e("div",{className:"fixed left-0 top-0 w-screen h-screen overflow-hidden bg-surface-1 bg-opacity-20 backdrop-blur-sm",onClick:()=>s("../")}),l("div",{className:"max-w-lg fixed right-0 top-0 h-screen bg-surface-5 pb-16 z-10 overflow-y-auto animate-slide-left px-8",children:[e("div",{className:"sticky top-0 bg-surface-5 pt-16 px-4 -mx-4 bg-opacity-50 backdrop-blur-sm z-10",children:e(I,{title:n.name+" "+n.lastName,back:!0})}),l("div",{className:"flex flex-col gap-6 mb-10",children:[l("div",{className:"flex flex-col gap-1 grow",children:[e("h2",{children:"Email"}),e("p",{children:n.email})]}),l(b,{spacing:4,children:[l("div",{className:"flex flex-col gap-1 grow",children:[e("h2",{children:"Company Code"}),e("p",{children:n.companyCode||"Sin c\xF3digo"})]}),l("div",{className:"flex flex-col gap-1 grow",children:[e("h2",{children:"Rol"}),e(M,{elements:n.roles})]})]})]}),e("div",{className:"flex flex-row gap-8 my-8",children:t?e("div",{className:"px-8 py-2 bg-emerald-500 rounded-md text-white mx-auto",children:"Email enviado"}):e("div",{className:"px-8 py-2 bg-blue rounded-md text-white cursor-pointer hover:bg-primary-40 mx-auto",onClick:()=>confirm(`\xBFQuiere reiniciar la contrase\xF1a de ${n.name} ${n.lastName}?
                  
                  Esto mandar\xE1 un c\xF3digo al correo ${n.email} para reiniciarla dentro de la app`)&&u,children:"Reiniciar Contrase\xF1a"})}),e("h2",{children:"M\xE9tricas"}),e(me,{}),l(b,{spacing:4,className:"my-8 mx-auto",justify:"center",grow:!0,items:"center",children:[e(F,{to:"history",label:"Historial"}),e(F,{to:"assigned",label:"Asignados"})]}),e("div",{className:"isolate",children:e(q,{})})]})]})})},ge=s=>{var n;if(!s.userId)return e(f,{message:"Invalid user id"});let{gradedAssessments:r,error:t,loading:a}=B(s.userId);return a?e($,{}):t?((n=t.response)==null?void 0:n.status)!=404?e(f,{message:t==null?void 0:t.toString()}):e("p",{children:"No ha contestado ning\xFAn examen"}):r.length>0?e(ae,{gradedAssessments:r.sort((i,o)=>new Date(o.endDate).valueOf()-new Date(i.endDate).valueOf())}):e("p",{children:"Este usuario no ha contestado ning\xFAn examen"})},pe=()=>{const{id:s}=v();if(!s)throw Error("No se encontr\xF3 el id");return l(N,{children:[e("h2",{children:"Historial"}),e(ge,{userId:s})]})},C="/v1/assessments",xe=(s,r)=>S(`${C}/${s}/assign-user/${r}`),fe=(s,r)=>J(`${C}/${s}/premium-access/${r}`),Ne=s=>K(`${C}/premium-access/${s}`),ve=(s,r)=>{const t=k();return R(a=>xe(a,s),{onSuccess:a=>{t.invalidateQueries(["users",a.userId,"premiumAssessments"]),t.invalidateQueries(["users",a.userId,"stats"]),r&&r()}})},ye=(s,r)=>{const t=k();return R(a=>fe(a,s),{onSuccess:a=>{console.log("aaaaa"),console.log(a.userId),t.invalidateQueries(["users",a.userId,"premiumAssessments"]),t.invalidateQueries(["users",a.userId,"stats"]),r&&r()}})},L=s=>{const{data:r,error:t,isLoading:a}=H(["users",s,"premiumAssessments"],()=>Ne(s));return{premiumAssessments:r,error:t,loading:a}},be=s=>{const{mutate:r,error:t,isLoading:a}=ye(s.userId,()=>alert("cancelado")),n=()=>{confirm(`Est\xE1s a punto de desasignar este examen
    \xBFQuieres continuar?`)&&r(s.assessmentId)};return e(p,{error:t,loading:a,children:()=>e("div",{className:"rounded-full w-8 h-8 bg-red-600 text-white cursor-pointer scale-100 hover:scale-110 transition-transform duration-150 absolute right-2 top-2 flex justify-center items-center",onClick:n,children:e(D,{})})})},we=s=>{if(!s.userId)throw Error("No se encontr\xF3 el id");const{premiumAssessments:r,error:t,loading:a}=L(s.userId);return e(p,{loading:a,error:t,children:()=>e("div",{className:"flex flex-col gap-8",children:r!==void 0&&r.map(n=>l("div",{className:"relative",children:[e(se,{assessment:n}),e(be,{userId:s.userId,assessmentId:n.id})]},n.id))})})},Ae=s=>{const[r,t]=h.exports.useState(!1),{mutate:a,error:n,isLoading:i}=ve(s.userId),{assessments:o,error:u,loading:m}=G(),d=o&&o.filter(c=>{var x;return c.isPremium&&!((x=s.assignedAssessments)!=null&&x.includes(c.id))});return r?e(p,{error:n||u,loading:i||m,children:()=>l("div",{className:"flex flex-col gap-4 mb-8",children:[e("p",{className:"text-lg",children:"Haz click en un examen para asign\xE1rselo al usuario"}),d.length>0?d.map(c=>e("div",{className:"cursor-pointer",onClick:()=>a(c.id),children:e("div",{className:"pointer-events-none",children:l(N,{children:[console.log(c),e(z,{assessment:c})]})})},c.id)):e("p",{children:"No hay ex\xE1menes que asignar"})]})}):e("div",{className:"bg-blue text-white px-4 py-2 cursor-pointer rounded-md justify-self-center text-center my-6",onClick:()=>t(!0),children:"Asignar un Examen"})},Ce=()=>{var n;const{id:s}=v();if(!s)throw Error("No se encontr\xF3 el id");const{premiumAssessments:r,error:t,loading:a}=L(s);return a?e($,{}):l(N,{children:[e("h2",{className:"mt-12 mb-4",children:"Ex\xE1menes Premium"}),e(Ae,{userId:s,assignedAssessments:r==null?void 0:r.map(i=>i.id)}),e("hr",{className:"my-6 border-t-orange border-t-2"}),e("h3",{className:"mb-4",children:"Asignados"}),t?((n=t.response)==null?void 0:n.status)===404?e("p",{children:"No se encontraron ex\xE1menes"}):e(f,{message:t.toString()}):e(we,{userId:s})]})},Ue=Ce,$e=()=>l(V,{children:[e(g,{path:"",element:e(oe,{}),children:l(g,{path:":id",element:e(he,{}),children:[e(g,{index:!0,element:e(X,{to:"history",replace:!0})}),e(g,{path:"history",element:e(pe,{})}),e(g,{path:"assigned",element:e(Ue,{})})]})}),e(g,{path:"new",element:e(de,{})}),e(g,{path:"*",element:e(re,{})})]});export{$e as default};
